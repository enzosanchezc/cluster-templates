apiVersion: v1
kind: Secret
metadata:
  labels:
    clusterctl.cluster.x-k8s.io/move: "true"
  name: {{ .Values.cluster.name }}-cloud-config
  namespace: fleet-default
  annotations:
    "helm.sh/hook": pre-install,post-delete
type: Opaque
stringData:
{{- if .Values.infraConfig.caCerts }}
  cacert: |-
    {{- $parts := split ":" .Values.infraConfig.caCerts }}
    {{- $namespace := index $parts 0 }}
    {{- $secretName := index $parts 1 }}
    {{ (lookup "v1" "ConfigMap" $namespace $secretName).data.cacert }}
{{- end }}
  clouds.yaml: |-
    clouds:
      openstack:
        auth:
          auth_url: {{ .Values.infraConfig.authUrl }}
          {{- if .Values.infraConfig.applicationCredentialName }}
          {{- $parts := split ":" .Values.infraConfig.applicationCredentialName }}
          {{- $namespace := index $parts 0 }}
          {{- $secretName := index $parts 1 }}
          application_credential_id: {{ (lookup "v1" "Secret" $namespace $secretName).data.applicationCredentialId | b64dec }}
          application_credential_secret: {{ (lookup "v1" "Secret" $namespace $secretName).data.applicationCredentialSecret | b64dec }}
          {{- end }}
          {{- if .Values.infraConfig.credentialName }}
          {{- $parts := split ":" .Values.infraConfig.credentialName }}
          {{- $namespace := index $parts 0 }}
          {{- $secretName := index $parts 1 }}
          username: {{ (lookup "v1" "Secret" $namespace $secretName).data.username | b64dec }}
          password: {{ (lookup "v1" "Secret" $namespace $secretName).data.password | b64dec }}
          {{- end }}
          project_name: {{ .Values.infraConfig.tenantName }}
          user_domain_name: {{ .Values.infraConfig.domainName }}
          domain_name: {{ .Values.infraConfig.domainName }}
        region_name: {{ .Values.infraConfig.region }}
        interface: "public"
        identity_api_version: 3
        {{- if .Values.infraConfig.applicationCredentialName }}
        auth_type: "v3applicationcredential"
        {{- end }}